<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-key="pageTitle">پنل مصرف ترافیک</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Professional Engineering Theme (Marzban Style) --- */
        :root {
            /* Core Colors based on screenshots */
            --bg-body: #151521; /* Deep dark background */
            --bg-card: #1E1E2D; /* Lighter panel background */
            --bg-input: #151521; /* Dark input background */
            
            --border-color: #323248; /* Subtle borders */
            --border-focus: #5865F2; /* Blurple focus color */

            --text-main: #FFFFFF;
            --text-muted: #92929F; /* Professional muted text */
            --text-label: #5E6278; /* Darker label text */

            --primary: #5865F2; /* Discord/Marzban Blurple */
            --primary-hover: #4752C4;
            
            --success: #1BC5BD; /* Teal/Green for success */
            --warning: #FFA800; /* Amber for warning */
            --danger: #F64E60; /* Red for errors */
            
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
        }

        body.light-mode {
            --bg-body: #F5F8FA;
            --bg-card: #FFFFFF;
            --bg-input: #F5F8FA;
            --border-color: #EBEDF3;
            --text-main: #181C32;
            --text-muted: #7E8299;
            --text-label: #B5B5C3;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            font-size: 0.92rem; /* Slightly compact for engineer look */
            -webkit-font-smoothing: antialiased;
        }

        /* --- Utilities --- */
        .text-muted { color: var(--text-muted) !important; }
        .text-success { color: var(--success) !important; }
        .text-warning { color: var(--warning) !important; }
        .text-danger { color: var(--danger) !important; }
        .bg-card { background-color: var(--bg-card); }

        /* --- Login Screen Styling (Matches Screenshot 2) --- */
        #loginForm {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at center, rgba(88, 101, 242, 0.05) 0%, transparent 70%);
            z-index: 50;
        }

        .login-card {
            background-color: var(--bg-card);
            padding: 3rem;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 0 50px 0 rgba(0,0,0,0.15);
            border: 1px solid var(--border-color);
        }

        .login-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 1.5rem auto;
            color: var(--primary);
        }

        /* --- Navbar & Layout --- */
        .navbar {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            height: 70px;
            display: flex;
            align-items: center;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 40;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        .container-custom {
            max-width: 1400px; /* Wide layout for dashboards */
            margin: 0 auto;
            padding: 2rem;
        }

        /* --- Cards (Dashboard Style) --- */
        .card-panel {
            background-color: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card-panel:hover {
            /* Subtle lift for interaction */
            border-color: rgba(88, 101, 242, 0.3); 
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .card-value-big {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        .card-value-unit {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-right: 4px;
        }

        /* --- Inputs --- */
        .form-control {
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 0.85rem 1rem;
            border-radius: var(--radius-sm);
            width: 100%;
            font-size: 0.95rem;
            transition: all 0.2s;
            outline: none;
            direction: ltr; /* Usernames are usually English */
            text-align: left;
        }
        .form-control::placeholder {
            color: var(--text-label);
            text-align: right; /* Placeholder in Persian */
            direction: rtl;
        }
        .form-control:focus {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(88, 101, 242, 0.15);
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-main);
            font-weight: 500;
            text-align: right;
            font-size: 0.95rem;
        }

        /* --- Buttons --- */
        .btn {
            padding: 0.85rem 1.5rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.25);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            background-color: rgba(255,255,255,0.05);
            color: var(--text-muted);
            border-radius: var(--radius-sm);
        }
        .btn-icon:hover {
            background-color: rgba(88, 101, 242, 0.1);
            color: var(--primary);
        }

        /* --- Tables / Lists (Matches Screenshot 4) --- */
        .user-table-container {
            width: 100%;
            overflow-x: auto;
        }
        
        .user-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.1s;
        }
        .user-row:last-child {
            border-bottom: none;
        }
        .user-row:hover {
            background-color: rgba(255,255,255,0.02);
        }

        /* --- Progress Bars (Matches Screenshot 3) --- */
        .progress-track {
            background-color: rgba(255,255,255,0.05);
            border-radius: 4px;
            height: 6px;
            width: 100%;
            overflow: hidden;
            margin-top: 6px;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- Status Dots --- */
        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 6px;
        }

        /* --- Loading Spinner --- */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- Node Cards Grid --- */
        .node-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        /* --- Modals --- */
        .modal-overlay {
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        /* --- Chart Container --- */
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }

        /* Responsive Tweaks */
        @media (max-width: 768px) {
            .navbar { padding: 0 1rem; height: 60px; }
            .container-custom { padding: 1rem; }
            .card-value-big { font-size: 1.75rem; }
            .login-card { margin: 1rem; padding: 2rem; }
        }
    </style>
</head>
<body>

    <!-- Global Loading & Error (Moved out of dashboardContent to be visible on login) -->
    <div id="loadingIndicator" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[80] hidden">
        <div class="loading-spinner"></div>
    </div>
    
    <div id="errorMessage" class="hidden"></div>

    <!-- Login Screen -->
    <div id="loginForm">
        <div class="login-card">
            <!-- Icon resembling the logo in screenshot -->
            <svg class="login-logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            
            <h2 class="text-2xl font-bold mb-2" data-key="mainHeader">ورود به پنل</h2>
            <p class="text-muted mb-8 text-sm" data-key="loginSubtitle">لطفاً برای مشاهده وضعیت، نام کاربری و رمز عبور را وارد کنید</p>

            <div class="space-y-4">
                <div>
                    <label class="form-label" for="loginUsernameInput" data-key="loginUsernameLabel">نام کاربری ادمین</label>
                    <input type="text" id="loginUsernameInput" class="form-control" placeholder="Admin Username">
                </div>
                
                <div>
                    <label class="form-label" for="loginPasswordInput" data-key="loginPasswordLabel">رمز عبور</label>
                    <input type="password" id="loginPasswordInput" class="form-control" placeholder="Password">
                </div>

                <button id="loginButton" class="btn btn-primary w-full mt-6" data-key="loginButton">
                    <span>ورود به حساب</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
                </button>
            </div>

            <p id="loginErrorMessage" class="text-danger mt-4 text-sm hidden" data-key="loginErrorMessage">نام کاربری یا رمز عبور اشتباه است.</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardContent" class="hidden min-h-screen flex flex-col">
        
        <!-- Navbar -->
        <nav class="navbar justify-between">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold tracking-tight text-white flex items-center gap-2">
                    <span class="w-2 h-6 bg-indigo-500 rounded-sm inline-block"></span>
                    <span data-key="pageTitle">داشبورد نظارت</span>
                </h1>
            </div>

            <div class="flex items-center gap-2 sm:gap-3">
                 <!-- Node Stats Button -->
                 <button id="nodeStatsButton" class="btn btn-icon hidden" title="Node Stats">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </button>

                <!-- Language Selector -->
                <div class="relative">
                    <select id="languageSelector" class="bg-card text-muted border border-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2">
                        <option value="fa">FA</option>
                        <option value="en">EN</option>
                    </select>
                </div>

                <!-- Theme Toggle -->
                <button id="themeToggle" class="btn btn-icon" title="Toggle Theme">
                    <svg id="themeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
                
                <!-- Support -->
                <button id="supportButton" class="btn btn-icon" title="Support">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </nav>

        <main class="container-custom flex-grow">
            <!-- User Lookup (Visible only after login for single user check) -->
            <div id="individualUserLookup" class="hidden mb-8">
                <div class="card-panel flex flex-col sm:flex-row gap-4 items-end">
                    <div class="w-full">
                        <label class="form-label" data-key="usernameLabel">جستجوی کاربر خاص</label>
                        <input type="text" id="usernameInput" class="form-control" placeholder="نام کاربری را وارد کنید...">
                    </div>
                    <button id="fetchDataButton" class="btn btn-primary whitespace-nowrap" data-key="fetchDataButton">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        <span>جستجو</span>
                    </button>
                </div>
            </div>

            <!-- Charts Section -->
            <div id="consumptionChartCard" class="card-panel mb-8 hidden">
                <div class="card-header">
                    <div>
                        <h2 class="card-title" data-key="chartHeader">نمودار مصرف کل</h2>
                        <p class="text-xs text-muted mt-1">روند مصرف ترافیک سرور در بازه‌های زمانی مختلف</p>
                    </div>
                    <div id="chartTimeRange" class="flex bg-body p-1 rounded-lg">
                        <button class="px-3 py-1 text-xs rounded-md transition-colors text-muted hover:text-white" data-range="7d" data-key="chart7d">7 روز</button>
                        <button class="px-3 py-1 text-xs rounded-md transition-colors text-muted hover:text-white" data-range="30d" data-key="chart30d">30 روز</button>
                        <button class="px-3 py-1 text-xs rounded-md transition-colors bg-indigo-500 text-white shadow-sm" data-range="all" data-key="chartAll">کل</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="consumptionChart"></canvas>
                </div>
            </div>

            <!-- Stats Grid -->
            <div id="dataCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 hidden">
                <!-- Card 1 -->
                <div class="card-panel">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-muted text-sm font-medium" data-key="totalVolume">حجم کل مجاز</span>
                        <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <div id="total2" class="card-value-big">--</div>
                    </div>
                </div>

                <!-- Card 2 -->
                <div class="card-panel">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-muted text-sm font-medium" data-key="consumed">مصرف شده</span>
                        <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <div id="usage" class="card-value-big text-indigo-400">--</div>
                    </div>
                </div>

                <!-- Card 3 -->
                <div class="card-panel">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-muted text-sm font-medium" data-key="remainingVolume">باقیمانده</span>
                        <div class="p-2 bg-amber-500/10 rounded-lg text-amber-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <div id="baghi" class="card-value-big text-warning">--</div>
                    </div>
                </div>

                 <!-- Card 4 (Prediction) -->
                 <div class="card-panel">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-muted text-sm font-medium" data-key="predictionHeader">اتمام تخمینی</span>
                        <div class="p-2 bg-pink-500/10 rounded-lg text-pink-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <div id="predictionMessage" class="text-xl font-bold text-pink-400">--</div>
                        <div id="date2" class="text-xs text-muted mt-1">مدت فعال: --</div>
                    </div>
                </div>
            </div>
            
             <!-- Backup Action Card -->
             <div id="backupFeatureCard" class="card-panel mb-8 hidden flex-row items-center justify-between">
                <div>
                    <h3 class="font-bold text-lg mb-1" data-key="backupPanelHeader">پشتیبان‌گیری کاربران</h3>
                    <p class="text-muted text-sm" data-key="backupPanelDescription">تهیه نسخه پشتیبان از تمامی کاربران جهت امنیت داده‌ها</p>
                </div>
                <button id="getBackupButton" class="btn btn-primary">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    <span>دانلود بکاپ</span>
                </button>
            </div>

            <!-- Lists (Top/Least Users) -->
            <div id="userUsageLists" class="grid grid-cols-1 lg:grid-cols-2 gap-8 hidden">
                
                <!-- Top Users -->
                <div class="card-panel p-0 overflow-hidden">
                    <div class="p-6 border-b border-gray-700/50 flex justify-between items-center">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-red-500"></span>
                            <span data-key="topUsersHeader">کاربران پرمصرف</span>
                        </h3>
                    </div>
                    <div id="topUsersList" class="user-table-container max-h-[400px] overflow-y-auto">
                        <!-- Items injected here -->
                    </div>
                </div>

                <!-- Least Users -->
                 <div class="card-panel p-0 overflow-hidden">
                    <div class="p-6 border-b border-gray-700/50 flex justify-between items-center">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                            <span data-key="leastUsersHeader">کاربران کم‌مصرف</span>
                        </h3>
                    </div>
                    <div id="leastUsersList" class="user-table-container max-h-[400px] overflow-y-auto">
                        <!-- Items injected here -->
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center py-8 text-muted text-sm">
            <p data-key="footerText">تمامی حقوق محفوظ است © 2025</p>
        </footer>
    </div>

    <!-- Modals (Support, Backup, Node Stats) -->
    
    <!-- Support Modal -->
    <div id="supportModal" class="modal-overlay fixed inset-0 hidden z-[60] flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-lg h-[600px] rounded-xl overflow-hidden relative flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-card">
                <h3 class="font-bold" data-key="supportButtonTitle">پشتیبانی</h3>
                <button id="closeSupportModalButton" class="text-muted hover:text-white p-2">✕</button>
            </div>
            <iframe id="goftinoIframe" class="flex-grow w-full border-none bg-white"></iframe>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupDownloadModal" class="modal-overlay fixed inset-0 hidden z-[60] flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-md rounded-xl p-6 text-center">
            <div class="mb-4 text-emerald-500 flex justify-center">
                <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h3 class="text-xl font-bold mb-2 text-white" data-key="backupReadyText">بکاپ آماده است</h3>
            <p class="text-muted mb-6 text-sm" data-key="backupDownloadPrompt">فایل JSON حاوی اطلاعات کاربران آماده دانلود می‌باشد.</p>
            
            <a id="modalDownloadLink" href="#" class="btn btn-primary w-full justify-center mb-4">
                دانلود فایل
            </a>
            
            <div id="backupDetailsContainer" class="text-xs text-muted text-right bg-body p-3 rounded-lg space-y-2"></div>
            
            <button id="closeBackupDownloadModalButton" class="text-muted hover:text-white text-sm mt-4">بستن</button>
        </div>
    </div>

    <!-- Node Stats Modal -->
    <div id="nodeStatsModal" class="modal-overlay fixed inset-0 hidden z-[60] flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-4xl max-h-[85vh] rounded-xl flex flex-col">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center">
                <h3 class="font-bold text-lg" data-key="nodeStatsHeader">وضعیت سرورها (Nodes)</h3>
                <button id="closeNodeStatsModalButton" class="text-muted hover:text-white p-2">✕</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="nodeStatsList" class="node-grid">
                    <!-- Nodes injected here -->
                </div>
                <p id="nodeStatsError" class="text-danger text-center hidden mt-4"></p>
            </div>
        </div>
    </div>

    <script>
        // --- JS Logic (Updated for new classes but keeping logic same) ---

        // Helper: Show Toast Message (Replacing old showMessage)
        function showMessage(text, type = 'info', duration = 3000) {
            const currentTrans = translations[currentLanguage];
            // For login, specific logic
            if(type === 'error' && text.includes(currentTrans.loginErrorMessage)) {
                 const el = document.getElementById('loginErrorMessage');
                 el.textContent = text;
                 el.classList.remove('hidden');
                 return;
            }

            const targetElement = document.getElementById('errorMessage'); // Generic error container
            targetElement.textContent = text;
            targetElement.className = `p-4 rounded-lg text-center mb-6 fixed top-20 left-1/2 transform -translate-x-1/2 z-[90] shadow-lg border backdrop-blur-md transition-all duration-300 ${type === 'error' ? 'bg-red-500/10 border-red-500/20 text-red-500' : 'bg-green-500/10 border-green-500/20 text-green-500'}`;
            targetElement.classList.remove('hidden');

            setTimeout(() => {
                targetElement.classList.add('hidden');
            }, duration);
        }

        // --- DOM Elements ---
        const htmlElement = document.documentElement;
        const bodyElement = document.body;
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const languageSelector = document.getElementById('languageSelector');
        const supportButton = document.getElementById('supportButton'); 
        const supportModal = document.getElementById('supportModal');
        const closeSupportModalButton = document.getElementById('closeSupportModalButton');
        const goftinoIframe = document.getElementById('goftinoIframe');

        const loginForm = document.getElementById('loginForm');
        const loginUsernameInput = document.getElementById('loginUsernameInput');
        const loginPasswordInput = document.getElementById('loginPasswordInput');
        const loginButton = document.getElementById('loginButton');
        const loginErrorMessage = document.getElementById('loginErrorMessage');
        const dashboardContent = document.getElementById('dashboardContent');

        const usernameInput = document.getElementById('usernameInput');
        const fetchDataButton = document.getElementById('fetchDataButton');
        const individualUserLookup = document.getElementById('individualUserLookup'); 

        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const dataCards = document.getElementById('dataCards');
        const userUsageLists = document.getElementById('userUsageLists'); 
        const topUsersList = document.getElementById('topUsersList');      
        const leastUsersList = document.getElementById('leastUsersList'); 

        const predictionMessage = document.getElementById('predictionMessage'); 

        const getBackupButton = document.getElementById('getBackupButton');
       
        const backupDownloadModal = document.getElementById('backupDownloadModal');
        const closeBackupDownloadModalButton = document.getElementById('closeBackupDownloadModalButton');
        const modalDownloadLink = document.getElementById('modalDownloadLink');
        const backupDetailsContainer = document.getElementById('backupDetailsContainer');
        
        const consumptionChartCard = document.getElementById('consumptionChartCard');
        const consumptionChartCanvas = document.getElementById('consumptionChart').getContext('2d');
        const chartTimeRangeButtons = document.querySelectorAll('#chartTimeRange button'); // Updated selector
        let consumptionChart;

        const nodeStatsButton = document.getElementById('nodeStatsButton');
        const nodeStatsModal = document.getElementById('nodeStatsModal');
        const closeNodeStatsModalButton = document.getElementById('closeNodeStatsModalButton');
        const nodeStatsList = document.getElementById('nodeStatsList');
        const nodeStatsError = document.getElementById('nodeStatsError');

        // --- State Variables ---
        let currentTrafficData = {}; 
        let currentLanguage = localStorage.getItem('language') || 'fa';
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let accessToken = localStorage.getItem('marzban_access_token') || null; 
        
        const CLOUDFLARE_WORKER_URL = 'https://home-vor.amiruserbot7.workers.dev/'; 

        // Translations (Keeping same logic)
        const translations = {
            fa: {
                pageTitle: 'داشبورد مدیریت ترافیک', 
                mainHeader: 'ورود به پنل', 
                loginSubtitle: 'برای دسترسی به اطلاعات لطفا وارد شوید',
                usernameLabel: 'نام کاربری کاربر:',
                fetchDataButton: 'جستجو',
                errorMessage: 'خطا در دریافت اطلاعات.',
                invalidUsernameError: 'نام کاربری نامعتبر است.',
                fetchErrorGeneric: 'خطا: {error}',
                totalVolume: 'حجم کل مجاز',
                remainingVolume: 'باقیمانده',
                consumed: 'مصرف شده',
                daysPassed: 'مدت فعال',
                notAvailable: '---',
                invalidDateFormat: 'تاریخ نامعتبر', 
                daysUnit: 'روز',
                unknown: 'نامشخص',
                footerText: 'تمامی حقوق محفوظ است © 2025', 
                themeToggleTitle: 'تغییر تم',
                supportButtonTitle: 'پشتیبانی',
                closeButtonTitle: 'بستن',
                loginUsernameLabel: 'نام کاربری ادمین',
                loginPasswordLabel: 'رمز عبور',
                loginButton: 'ورود به حساب',
                loginErrorMessage: 'نام کاربری یا رمز عبور اشتباه است.',
                topUsersHeader: 'کاربران پرمصرف', 
                leastUsersHeader: 'کاربران کم‌مصرف', 
                noUsersFound: 'کاربری یافت نشد.',
                predictionHeader: 'اتمام تخمینی', 
                predictionMessageNoData: 'داده ناکافی', 
                predictionMessageNoConsumption: 'بدون مصرف', 
                predictionMessageDepleted: 'تمام شده',
                backupPanelHeader: 'پشتیبان‌گیری',
                backupPanelDescription: 'دانلود فایل بکاپ کامل کاربران',
                backupReadyText: 'بکاپ آماده است',
                backupDownloadPrompt: 'فایل آماده دانلود است:',
                backupSuccessMessage: 'بکاپ با موفقیت ایجاد شد',
                backupErrorMessage: 'خطا در تهیه بکاپ',
                backupNoUsersFound: 'کاربری برای بکاپ وجود ندارد',
                totalUsersCount: 'تعداد کاربران:',
                activeUsersCount: 'فعال:',
                expiredUsersCount: 'منقضی:',
                backupAdminName: 'ادمین:',
                backupDateTime: 'زمان:',
                unlimited: 'نامحدود',
                chartHeader: 'نمودار مصرف کل',
                chart7d: '7 روز',
                chart30d: '30 روز',
                chartAll: 'کل',
                nodeStatsButtonTitle: 'وضعیت نودها',
                nodeStatsHeader: 'وضعیت سرورها',
                nodeStatsError: 'خطا در دریافت وضعیت نودها',
                nodeTrafficIn: 'ورودی',
                nodeTrafficOut: 'خروجی',
                nodeCpuUsage: 'پردازنده',
                nodeRamUsage: 'رم',
                statusConnected: 'متصل',
                statusError: 'خطا',
                statusOffline: 'آفلاین',
            },
            en: {
                pageTitle: 'Traffic Dashboard', 
                mainHeader: 'Login Panel', 
                loginSubtitle: 'Please login to access dashboard',
                usernameLabel: 'User Username:',
                fetchDataButton: 'Search',
                errorMessage: 'Error fetching data.',
                invalidUsernameError: 'Invalid username.',
                fetchErrorGeneric: 'Error: {error}',
                totalVolume: 'Total Volume',
                remainingVolume: 'Remaining',
                consumed: 'Consumed',
                daysPassed: 'Active Days',
                notAvailable: 'N/A',
                invalidDateFormat: 'Invalid Date', 
                daysUnit: 'days',
                unknown: 'Unknown',
                footerText: 'All rights reserved © 2025', 
                themeToggleTitle: 'Toggle Theme',
                supportButtonTitle: 'Support',
                closeButtonTitle: 'Close',
                loginUsernameLabel: 'Admin Username',
                loginPasswordLabel: 'Password',
                loginButton: 'Sign In',
                loginErrorMessage: 'Invalid credentials.',
                topUsersHeader: 'Top Users', 
                leastUsersHeader: 'Least Users', 
                noUsersFound: 'No users found.',
                predictionHeader: 'Est. Depletion', 
                predictionMessageNoData: 'No Data', 
                predictionMessageNoConsumption: 'No Usage', 
                predictionMessageDepleted: 'Depleted',
                backupPanelHeader: 'Backup Users',
                backupPanelDescription: 'Download full user backup',
                backupReadyText: 'Backup Ready',
                backupDownloadPrompt: 'File ready to download:',
                backupSuccessMessage: 'Backup generated successfully',
                backupErrorMessage: 'Backup failed',
                backupNoUsersFound: 'No users to backup',
                totalUsersCount: 'Total Users:',
                activeUsersCount: 'Active:',
                expiredUsersCount: 'Expired:',
                backupAdminName: 'Admin:',
                backupDateTime: 'Time:',
                unlimited: 'Unlimited',
                chartHeader: 'Total Consumption',
                chart7d: '7 Days',
                chart30d: '30 Days',
                chartAll: 'All',
                nodeStatsButtonTitle: 'Node Status',
                nodeStatsHeader: 'Server Status',
                nodeStatsError: 'Error fetching node stats',
                nodeTrafficIn: 'Inbound',
                nodeTrafficOut: 'Outbound',
                nodeCpuUsage: 'CPU',
                nodeRamUsage: 'RAM',
                statusConnected: 'Connected',
                statusError: 'Error',
                statusOffline: 'Offline',
            }
        };

        function convertTrafficToMB(trafficString) {
             const currentTrans = translations[currentLanguage];
            if (!trafficString || trafficString === currentTrans.unknown || trafficString === 'نامشخص') return 0;
            const parts = trafficString.trim().split(' ');
            if (parts.length !== 2) return 0;

            const value = parseFloat(parts[0]);
            const unit = parts[1].toLowerCase();
            
            const GIGABYTE = 1024;
            const TERABYTE = GIGABYTE * 1024;

            const persianUnitMap = {
                'بایت': 'bytes', 'کیلوبایت': 'kb', 'مگابایت': 'mb', 'گیگابایت': 'gb', 'ترابایت': 'tb'
            };
            const normalizedUnit = persianUnitMap[unit] || unit;

            switch (normalizedUnit) {
                case 'bytes': return value / (1024 * 1024);
                case 'kb': return value / 1024;
                case 'mb': return value;
                case 'gb': return value * GIGABYTE;
                case 'tb': return value * TERABYTE;
                default: return 0;
            }
        }

        function applyTranslations(lang) {
            const currentTrans = translations[lang];
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                if (currentTrans[key]) {
                    if (element.tagName === 'BUTTON' && (element.id === 'themeToggle' || element.id === 'supportButton' || element.id.startsWith('close') || element.id === 'nodeStatsButton')) {
                        element.title = currentTrans[key];
                    } else if (element.tagName === 'INPUT') {
                         element.placeholder = currentTrans[key]; // For placeholders
                    } else {
                        // Check if element has children structure we want to preserve (like icons)
                         if(element.children.length > 0 && element.tagName === 'BUTTON') {
                             // simplistic check for buttons with icons
                             const span = element.querySelector('span');
                             if(span) span.textContent = currentTrans[key];
                         } else {
                             element.textContent = currentTrans[key];
                         }
                    }
                }
            });
            document.querySelector('title').textContent = currentTrans.pageTitle;
            
            htmlElement.setAttribute('lang', lang);
            htmlElement.setAttribute('dir', lang === 'fa' ? 'rtl' : 'ltr');
            bodyElement.setAttribute('dir', lang === 'fa' ? 'rtl' : 'ltr');

            // Refresh data if visible
             if (dashboardContent && !dashboardContent.classList.contains('hidden') && accessToken) {
                 fetchUserLists(); // Re-fetch to update potential static text in lists if any (though lists are dynamic)
             }
        }

        function setTheme(theme) {
            if (theme === 'light') {
                bodyElement.classList.add('light-mode');
            } else {
                bodyElement.classList.remove('light-mode');
            }
            localStorage.setItem('theme', theme);
            currentTheme = theme;
        }

        function initializePreferences() {
            setTheme(currentTheme);
            languageSelector.value = currentLanguage;
            applyTranslations(currentLanguage);

            if (accessToken) {
                loginForm.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                individualUserLookup.classList.remove('hidden'); // Show lookup
                nodeStatsButton.classList.remove('hidden');
                fetchUserLists(); 
                updateChart('7d');
            } else {
                loginForm.classList.remove('hidden');
                dashboardContent.classList.add('hidden');
                nodeStatsButton.classList.add('hidden');
            }
        }

        themeToggle.addEventListener('click', () => {
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        languageSelector.addEventListener('change', (event) => {
            currentLanguage = event.target.value;
            localStorage.setItem('language', currentLanguage);
            applyTranslations(currentLanguage);
        });

        function hideSupportModal() {
            supportModal.classList.remove('show');
            supportModal.classList.add('hidden');
            goftinoIframe.src = '';
        }

        supportButton.addEventListener('click', () => {
            supportModal.classList.remove('hidden');
            supportModal.classList.add('show');
            goftinoIframe.src = 'https://www.goftino.com/c/UTban7'; 
        });
        closeSupportModalButton.addEventListener('click', hideSupportModal);
        supportModal.addEventListener('click', (event) => event.target === supportModal && hideSupportModal());

        async function handleLogin() {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();
            if (!username || !password) {
                showMessage(translations[currentLanguage].loginErrorMessage, 'error');
                return;
            }

            loginButton.disabled = true;
            // loginErrorMessage.classList.add('hidden'); // handled by showMessage

            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                 const responseText = await response.text();
                let data;

                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`Invalid Server Response`);
                }

                if (!response.ok) {
                    throw new Error(data.error || translations[currentLanguage].loginErrorMessage);
                }

                accessToken = data.access_token;
                localStorage.setItem('marzban_access_token', accessToken);

                loginForm.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                individualUserLookup.classList.remove('hidden');
                nodeStatsButton.classList.remove('hidden');

                fetchUserData(username); // Admin data? Usually admin user isn't in user list same way
                fetchUserLists(); 
                updateChart('7d'); 

            } catch (error) {
                console.error('Login error:', error);
                showMessage(error.message, 'error');
            } finally {
                loginButton.disabled = false;
            }
        }
        loginButton.addEventListener('click', handleLogin);
        loginPasswordInput.addEventListener('keydown', (event) => event.key === 'Enter' && handleLogin());

        // --- Chart Logic ---
        async function fetchPanelConsumptionData(timeRange = '7d') {
            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}panel-consumption-history?range=${timeRange}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                const responseText = await response.text();
                if (!response.ok) return { labels: [], data: [] };
                
                try {
                    return JSON.parse(responseText);
                } catch (e) {
                    return { labels: [], data: [] };
                }
            } catch (error) {
                return { labels: [], data: [] };
            }
        }

        function renderConsumptionChart({ labels, data }) {
            if (consumptionChart) consumptionChart.destroy();
            
            const isDarkMode = currentTheme === 'dark';
            // Professional Chart Colors
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)';
            const textColor = isDarkMode ? '#92929F' : '#7E8299';
            const lineColor = '#5865F2'; // Blurple
            const fillColor = 'rgba(88, 101, 242, 0.1)'; // Subtle fill

            consumptionChart = new Chart(consumptionChartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Data Usage (GB)',
                        data: data,
                        borderColor: lineColor,
                        backgroundColor: fillColor,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3, // Smooth curves
                        pointRadius: 0, // No points usually looks cleaner
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: isDarkMode ? '#1E1E2D' : '#FFFFFF',
                            titleColor: isDarkMode ? '#FFFFFF' : '#000000',
                            bodyColor: textColor,
                            borderColor: gridColor,
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: { label: context => `${context.parsed.y} GB` }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor, font: { family: 'Vazirmatn', size: 11 } }
                        },
                        y: {
                            grid: { color: gridColor, borderDash: [4, 4] },
                            ticks: { color: textColor, font: { family: 'Vazirmatn', size: 11 } },
                            border: { display: false }
                        }
                    }
                }
            });
        }

        async function updateChart(timeRange) {
            // Update button states
            chartTimeRangeButtons.forEach(btn => {
                if(btn.dataset.range === timeRange) {
                     btn.className = "px-3 py-1 text-xs rounded-md transition-colors bg-indigo-500 text-white shadow-sm";
                } else {
                     btn.className = "px-3 py-1 text-xs rounded-md transition-colors text-muted hover:text-white";
                }
            });

            try {
                const chartData = await fetchPanelConsumptionData(timeRange);
                if(chartData && chartData.labels && chartData.data && chartData.data.length > 0) {
                    consumptionChartCard.classList.remove('hidden');
                    renderConsumptionChart(chartData);
                } else {
                    consumptionChartCard.classList.add('hidden');
                }
            } catch (error) {
                consumptionChartCard.classList.add('hidden');
            }
        }

        chartTimeRangeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const range = button.getAttribute('data-range');
                updateChart(range);
            });
        });

        // --- User Lists (Table Style) ---
        async function fetchUserLists() {
            if (!accessToken) return;
            userUsageLists.classList.add('hidden');
            // loadingIndicator.classList.remove('hidden'); // Optional: show loading

            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}users-summary`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const responseText = await response.text();
                let data;
                try { data = JSON.parse(responseText); } catch (e) { throw new Error('Invalid JSON'); }

                if (!response.ok) {
                    if (response.status === 401) {
                         // Session expired logic
                        localStorage.removeItem('marzban_access_token');
                        accessToken = null;
                        initializePreferences(); // Reset view
                        return; 
                    }
                    throw new Error(data.error || `Failed to fetch lists`);
                }

                const renderUserRow = (user) => {
                    const div = document.createElement('div');
                    div.className = `user-row cursor-pointer`; 
                    div.addEventListener('click', () => {
                        usernameInput.value = user.username;
                        fetchUserData(user.username);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });

                    let percentage = 0;
                    let progressBarColor = 'bg-emerald-500';
                    const usedBytes = user.used_traffic || 0;
                    const totalBytes = user.data_limit;

                    if (totalBytes && totalBytes > 0) {
                        percentage = Math.min(100, (usedBytes / totalBytes) * 100);
                        if(percentage > 90) progressBarColor = 'bg-red-500';
                        else if(percentage > 70) progressBarColor = 'bg-amber-500';
                    }

                    div.innerHTML = `
                        <div class="flex-1 min-w-0 pr-4">
                            <p class="text-sm font-bold text-white truncate">${user.username}</p>
                            <div class="progress-track">
                                <div class="progress-fill ${progressBarColor}" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <div class="text-left pl-2">
                             <p class="text-xs text-muted mb-1">${percentage.toFixed(1)}%</p>
                             <p class="text-xs font-mono text-white">${user.used_traffic_formatted}</p>
                        </div>
                    `;
                    return div;
                };

                topUsersList.innerHTML = '';
                if (data.top_users?.length) data.top_users.slice(0, 10).forEach(user => topUsersList.appendChild(renderUserRow(user)));
                
                leastUsersList.innerHTML = '';
                if (data.least_users?.length) data.least_users.slice(0, 10).forEach(user => leastUsersList.appendChild(renderUserRow(user)));
                
                userUsageLists.classList.remove('hidden');
                backupFeatureCard.classList.remove('hidden');
                backupFeatureCard.classList.add('flex'); // Ensure flex is restored
            } catch (error) {
                console.error(error);
            }
        }

        async function fetchUserData(username) {
            if (!username) return;
            loadingIndicator.classList.remove('hidden');
            // errorMessage.classList.add('hidden');
            // dataCards.classList.add('hidden');

            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}?username=${encodeURIComponent(username)}`);
                const responseText = await response.text();
                let data;
                try { data = JSON.parse(responseText); } catch (e) { throw new Error('Invalid JSON'); }

                if (!response.ok) throw new Error(data.error || 'API Error');
                if (data.error) throw new Error(data.error);

                currentTrafficData = data; 
                updateUI(data); 
                dataCards.classList.remove('hidden');
            } catch (error) {
                showMessage(translations[currentLanguage].fetchErrorGeneric.replace('{error}', error.message), 'error');
                dataCards.classList.add('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        fetchDataButton.addEventListener('click', () => fetchUserData(usernameInput.value.trim()));
        usernameInput.addEventListener('keydown', (event) => event.key === 'Enter' && fetchUserData(usernameInput.value.trim()));

        function updateUI(data) {
            const currentTrans = translations[currentLanguage];
            const formatWithUnit = (val) => val?.includes(' ') ? `${val.split(' ')[0]} <span class="card-value-unit">${val.split(' ')[1]}</span>` : val || currentTrans.unknown;

            document.getElementById('total2').innerHTML = formatWithUnit(data.total2);
            document.getElementById('baghi').innerHTML = formatWithUnit(data.baghi);
            document.getElementById('usage').innerHTML = formatWithUnit(data.usage);
            document.getElementById('date2').innerHTML = data.date2 ? `${data.date2} ${currentTrans.daysUnit}` : currentTrans.unknown;

            // Prediction Logic
            const totalMB = convertTrafficToMB(data.total2), usedMB = convertTrafficToMB(data.usage), days = parseFloat(data.date2);
            const predictionEl = document.getElementById('predictionMessage');
            
            if (days > 0 && usedMB > 0 && totalMB > 0) {
                const remainingMB = totalMB - usedMB;
                if (remainingMB > 0) {
                    const daysLeft = Math.round(remainingMB / (usedMB / days));
                    predictionEl.textContent = `${daysLeft} ${currentTrans.daysUnit}`;
                    predictionEl.className = 'text-xl font-bold text-white';
                } else {
                    predictionEl.textContent = currentTrans.predictionMessageDepleted;
                    predictionEl.className = 'text-xl font-bold text-danger';
                }
            } else {
                predictionEl.textContent = currentTrans.notAvailable;
                 predictionEl.className = 'text-xl font-bold text-muted';
            }
        }

        // --- Backup ---
        getBackupButton.addEventListener('click', async () => {
             const currentTrans = translations[currentLanguage];
            if (!accessToken) return showMessage(currentTrans.loginErrorMessage, 'error');

            // showMessage('Generating backup...', 'info');
            getBackupButton.disabled = true;

            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}backup-users`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const responseText = await response.text();
                let data;
                try { data = JSON.parse(responseText); } catch(e) { throw new Error('Invalid JSON'); }
                if (!response.ok) throw new Error(data.error || `Failed`);
                
                const users = data.users;
                if (!users?.length) return showMessage(currentTrans.backupNoUsersFound, 'info');

                const url = URL.createObjectURL(new Blob([JSON.stringify(users, null, 2)], { type: 'application/json' }));
                const now = new Date();
                const activeUsers = users.filter(u => u.status === 'active').length;

                modalDownloadLink.href = url;
                modalDownloadLink.download = `backup_${now.toISOString().slice(0, 10)}.json`;
                
                backupDetailsContainer.innerHTML = `
                    <div class="flex justify-between"><span>${currentTrans.totalUsersCount}</span><span class="text-white">${users.length}</span></div>
                    <div class="flex justify-between"><span>${currentTrans.activeUsersCount}</span><span class="text-emerald-400">${activeUsers}</span></div>
                `;
                
                backupDownloadModal.classList.remove('hidden');
                backupDownloadModal.classList.add('show');
            } catch (error) {
                showMessage(`${currentTrans.backupErrorMessage}: ${error.message}`, 'error');
            } finally {
                getBackupButton.disabled = false;
            }
        });

        function hideBackupModal() {
            backupDownloadModal.classList.remove('show');
            backupDownloadModal.classList.add('hidden');
        }
        closeBackupDownloadModalButton.addEventListener('click', hideBackupModal);

        // --- Node Stats ---
        async function fetchNodeStats() {
            const currentTrans = translations[currentLanguage];
            if (!accessToken) return;

            nodeStatsList.innerHTML = `<div class="loading-spinner m-auto"></div>`;
            nodeStatsError.classList.add('hidden');
            nodeStatsModal.classList.remove('hidden');
            nodeStatsModal.classList.add('show');

            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}node-stats`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const responseText = await response.text();
                let data;
                try { data = JSON.parse(responseText); } catch(e) { throw new Error('Invalid JSON'); }

                if (!response.ok) throw new Error(data.error || `Failed`);
                
                renderNodeStats(data.nodes);

            } catch (error) {
                nodeStatsError.textContent = `${currentTrans.nodeStatsError}: ${error.message}`;
                nodeStatsError.classList.remove('hidden');
                nodeStatsList.innerHTML = '';
            }
        }
        
        function renderNodeStats(nodes) {
            const currentTrans = translations[currentLanguage];
            nodeStatsList.innerHTML = '';
            
            if (!nodes || nodes.length === 0) {
                nodeStatsList.innerHTML = `<p class="text-center text-muted col-span-full">No nodes found.</p>`;
                return;
            }

            nodes.forEach(node => {
                let statusColorClass = 'bg-gray-500';
                if (node.status === 'connected') statusColorClass = 'bg-emerald-500';
                if (node.status === 'error') statusColorClass = 'bg-red-500';

                const cpuUsage = parseFloat(node.cpu_usage) || 0;
                const cpuProgressColor = cpuUsage > 80 ? 'bg-red-500' : 'bg-blue-500';
                
                const ramUsage = parseFloat(node.ram_usage_percent) || 0;
                const ramProgressColor = ramUsage > 85 ? 'bg-red-500' : 'bg-purple-500';

                const iconCpu = `<svg class="w-4 h-4 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>`;
                const iconRam = `<svg class="w-4 h-4 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>`;

                const nodeItem = document.createElement('div');
                nodeItem.className = 'card-panel p-4 h-auto';
                
                nodeItem.innerHTML = `
                    <div class="flex justify-between items-center mb-3 pb-3 border-b border-gray-700/50">
                        <span class="font-bold text-lg">${node.name}</span>
                        <div class="flex items-center gap-2 text-xs bg-gray-800 px-2 py-1 rounded">
                             <div class="status-dot ${statusColorClass}"></div>
                             <span class="text-muted">${node.status}</span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                             <div class="bg-gray-800/50 p-2 rounded">
                                <span class="text-muted block">↓ ${currentTrans.nodeTrafficIn}</span>
                                <span class="font-mono text-white">${node.traffic_in_formatted}</span>
                             </div>
                             <div class="bg-gray-800/50 p-2 rounded">
                                <span class="text-muted block">↑ ${currentTrans.nodeTrafficOut}</span>
                                <span class="font-mono text-white">${node.traffic_out_formatted}</span>
                             </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <div class="flex gap-1">${iconCpu} <span>CPU</span></div>
                                <span class="font-mono">${cpuUsage}%</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill ${cpuProgressColor}" style="width: ${cpuUsage}%"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <div class="flex gap-1">${iconRam} <span>RAM</span></div>
                                <span class="font-mono">${ramUsage}%</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill ${ramProgressColor}" style="width: ${ramUsage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
                nodeStatsList.appendChild(nodeItem);
            });
        }

        function hideNodeStatsModal() {
            nodeStatsModal.classList.remove('show');
            nodeStatsModal.classList.add('hidden');
        }

        nodeStatsButton.addEventListener('click', fetchNodeStats);
        closeNodeStatsModalButton.addEventListener('click', hideNodeStatsModal);
        nodeStatsModal.addEventListener('click', (event) => event.target === nodeStatsModal && hideNodeStatsModal());

        window.onload = initializePreferences;
    </script>
</body>
</html>

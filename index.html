<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل ترافیک مرزبان</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Fallback to sans-serif */
        }
        /* Custom styles for the traffic chart bars */
        .chart-bar-container {
            display: flex;
            align-items: flex-end;
            height: 150px; /* Fixed height for the chart area */
            border-bottom: 1px solid #4a5568; /* Light border for the chart base */
            padding-bottom: 5px; /* Space for labels */
        }
        .chart-bar {
            width: 10px; /* Width of each bar */
            margin: 0 2px; /* Space between bars */
            background-color: #4CAF50; /* Green color for bars */
            border-radius: 2px 2px 0 0; /* Rounded top corners */
            transition: height 0.3s ease-out; /* Smooth transition for height changes */
        }
        .chart-label {
            font-size: 0.75rem; /* Small font for labels */
            color: #a0aec0; /* Lighter color for labels */
            text-align: center;
            position: absolute;
            bottom: -20px; /* Position below the bar */
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .chart-wrapper {
            position: relative;
            overflow-x: auto; /* Allow horizontal scrolling for many bars */
            padding-bottom: 30px; /* Space for X-axis labels */
        }
        .chart-axis-y {
            position: absolute;
            right: 0; /* Position Y-axis on the right for RTL */
            top: 0;
            height: 100%;
            display: flex;
            flex-direction: column-reverse; /* Labels from bottom to top */
            justify-content: space-between;
            padding-right: 10px;
            font-size: 0.75rem;
            color: #a0aec0;
        }
        .chart-axis-y span {
            display: block;
            text-align: right;
            padding-left: 5px;
        }
        .chart-inner-container {
            display: flex;
            height: 100%;
            align-items: flex-end;
            padding-left: 40px; /* Space for Y-axis labels */
            min-width: 600px; /* Minimum width to prevent bars from being too wide on small data sets */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center sm:text-right">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-400 mb-2">
                <span id="welcomeMessage">سلام کاربر عزیز خوش آمدید !</span>
            </h1>
            <p class="text-gray-400 text-lg">داشبورد مدیریت ترافیک پنل مرزبان</p>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                <p class="text-gray-400 text-sm mb-2">وضعیت</p>
                <p id="status" class="text-2xl font-semibold text-green-400">فعال</p>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                <p class="text-gray-400 text-sm mb-2">زمان باقی مانده</p>
                <p id="remainingTime" class="text-2xl font-semibold text-yellow-400">1 روز</p>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                <p class="text-gray-400 text-sm mb-2">ترافیک مصرفی</p>
                <p id="usedTraffic" class="text-2xl font-semibold text-red-400">334 مگابایت</p>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                <p class="text-gray-400 text-sm mb-2">ترافیک کل</p>
                <p id="totalTraffic" class="text-2xl font-semibold text-blue-400">668 مگابایت</p>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                <p class="text-gray-400 text-sm mb-2">زمان باقی مانده (ثانیه)</p>
                <p id="remainingTimeSeconds" class="text-2xl font-semibold text-gray-300">0 ثانیه</p>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                <p class="text-gray-400 text-sm mb-2">ترافیک باقی مانده</p>
                <p id="remainingTrafficBytes" class="text-2xl font-semibold text-gray-300">0 بایت</p>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center col-span-1 md:col-span-2 lg:col-span-2">
                <p class="text-gray-400 text-sm mb-2">وضعیت پکیج فعال</p>
                <p id="activePackageStatus" class="text-2xl font-semibold text-purple-400">ندارد</p>
            </div>
        </section>

        <section class="bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold text-blue-400 mb-4 text-right">نمودار مصرف ترافیک</h2>
            <p class="text-gray-400 text-sm mb-4 text-right">ترافیک مصرفی شما در ساعات و روزهای اخیر</p>
            <div class="chart-wrapper relative">
                <div id="trafficChart" class="chart-inner-container">
                    </div>
                <div class="chart-axis-y">
                    <span>154 MB</span>
                    <span>100 MB</span>
                    <span>67 MB</span>
                    <span>33 MB</span>
                    <span>0 MB</span>
                </div>
            </div>
        </section>

        <footer class="text-center text-gray-500 text-sm mt-8">
            <p>&copy; 2024 پنل ترافیک مرزبان. تمامی حقوق محفوظ است.</p>
        </footer>
    </div>

    <script>
        // Function to fetch data from the API
        async function fetchMarzbanData() {
            // Replace with your actual API URL.
            // The 'name' parameter might need to be dynamic based on the logged-in admin.
            // For this example, we use 'dehghan_sa' as provided.
            const apiUrl = 'https://webs.speedmizban.net/a.php?name=dehghan_sa&step=info';

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('API Data:', data); // Log the data to inspect its structure

                // Update Dashboard UI with fetched data
                updateDashboardUI(data);

            } catch (error) {
                console.error('Error fetching Marzban data:', error);
                // Display an error message on the UI
                document.getElementById('welcomeMessage').textContent = 'خطا در بارگذاری اطلاعات!';
                // Optionally, disable parts of the UI or show placeholder data
            }
        }

        // Function to update the UI with fetched data
        function updateDashboardUI(data) {
            // --- Update Key Metrics ---
            // Assuming data structure like:
            // {
            //     "status": "فعال",
            //     "remaining_days": "1", // or "0"
            //     "used_traffic_mb": 334,
            //     "total_traffic_mb": 668,
            //     "remaining_time_seconds": 0,
            //     "remaining_traffic_bytes": 0,
            //     "chart_data": [
            //         {"time": "11.21", "usage_mb": 10},
            //         ...
            //     ],
            //     "user_name": "cdcdcdscdsc" // Assuming a user name field for welcome message
            // }

            // Welcome Message
            const userName = data.user_name || 'کاربر'; // Use a default if not provided
            document.getElementById('welcomeMessage').textContent = `سلام ${userName} عزیز خوش آمدید !`;

            // Status
            document.getElementById('status').textContent = data.status || 'نامشخص';
            if (data.status === 'فعال') {
                document.getElementById('status').classList.remove('text-red-400', 'text-yellow-400');
                document.getElementById('status').classList.add('text-green-400');
            } else {
                document.getElementById('status').classList.remove('text-green-400', 'text-yellow-400');
                document.getElementById('status').classList.add('text-red-400');
            }


            // Remaining Time
            document.getElementById('remainingTime').textContent = (data.remaining_days !== undefined ? data.remaining_days + ' روز' : 'نامشخص');

            // Used Traffic
            document.getElementById('usedTraffic').textContent = (data.used_traffic_mb !== undefined ? `${data.used_traffic_mb} مگابایت` : 'نامشخص');

            // Total Traffic
            document.getElementById('totalTraffic').textContent = (data.total_traffic_mb !== undefined ? `${data.total_traffic_mb} مگابایت` : 'نامشخص');

            // Remaining Time (Detail)
            document.getElementById('remainingTimeSeconds').textContent = (data.remaining_time_seconds !== undefined ? `${data.remaining_time_seconds} ثانیه` : 'نامشخص');

            // Remaining Traffic (Detail)
            document.getElementById('remainingTrafficBytes').textContent = (data.remaining_traffic_bytes !== undefined ? `${data.remaining_traffic_bytes} بایت` : 'نامشخص');

            // Active Package Status (Assuming 'active_package_status' field or similar)
            document.getElementById('activePackageStatus').textContent = data.active_package_status || 'ندارد';


            // --- Render Traffic Chart ---
            const trafficChartContainer = document.getElementById('trafficChart');
            trafficChartContainer.innerHTML = ''; // Clear previous bars

            // Example chart data structure: [{ time: "11.21", usage_mb: 10 }, ...]
            // If your API provides different keys or structure, adjust `data.chart_data` and inside the loop.
            const chartData = data.chart_data || generateMockChartData(); // Use mock data if API doesn't provide

            // Find max usage for scaling bars
            const maxUsage = Math.max(...chartData.map(item => item.usage_mb), 1); // Ensure not zero to avoid division by zero

            chartData.forEach(item => {
                const barWrapper = document.createElement('div');
                barWrapper.className = 'flex flex-col items-center relative h-full justify-end'; // Make wrapper take full height and align items to bottom

                const barHeight = (item.usage_mb / maxUsage) * 100; // Height as percentage of max
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${barHeight}%`; // Set bar height dynamically

                const label = document.createElement('span');
                label.className = 'chart-label';
                label.textContent = item.time; // Display time label

                barWrapper.appendChild(bar);
                barWrapper.appendChild(label);
                trafficChartContainer.appendChild(barWrapper);
            });
        }

        // Mock data generator for chart if API doesn't provide it or for testing
        function generateMockChartData() {
            const mockData = [];
            const hours = 24; // 24 hours for a full day
            for (let i = 0; i < hours; i++) {
                const hour = String(i).padStart(2, '0');
                const minute = String(Math.floor(Math.random() * 60)).padStart(2, '0'); // Random minute for variety
                mockData.push({
                    time: `${hour}.${minute}`,
                    usage_mb: Math.floor(Math.random() * 160) // Random usage up to 160 MB
                });
            }
            return mockData;
        }

        // Fetch data when the page loads
        window.onload = fetchMarzbanData;
    </script>
</body>
</html>

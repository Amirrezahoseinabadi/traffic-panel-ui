<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø±Ø²Ø¨Ø§Ù†</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" />
  <style>
    body {
      background-color: #f5f7fa;
      font-family: 'Vazirmatn', sans-serif; /* ÙØ±Ø¶ Ù…ÛŒ\u200cÚ©Ù†ÛŒÙ… ÙÙˆÙ†Øª ÙˆØ²ÛŒÙ† Ù…ØªØºÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªØŒ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø§Ø² ÙÙˆÙ†Øª\u200cÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ\u200cØ´ÙˆØ¯ */
    }
    .card {
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      border-radius: 10px;
    }
    .header {
      background: linear-gradient(90deg, #7f5af0, #2cb67d);
      color: white;
      padding: 20px;
      border-radius: 0 0 10px 10px;
    }
    .metric-card {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .metric-card .value {
      font-size: 1.8rem;
      font-weight: bold;
      color: #7f5af0; /* Purple for values */
    }
    .metric-card .label {
      font-size: 0.9rem;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="header text-center mb-4">
      <h2>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø±Ø²Ø¨Ø§Ù†</h2>
      <p>Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ø³Ø±ÙˆØ±Ù‡Ø§</p>
    </div>

    <div id="login-section">
      <div class="row justify-content-center mb-4">
        <div class="col-md-6">
          <div class="card p-4">
            <h5 class="card-title text-center mb-3">ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</h5>
            <input type="text" id="adminUser" class="form-control mb-2" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
            <input type="password" id="adminPass" class="form-control mb-3" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
            <button class="btn btn-primary w-100" onclick="login()">ÙˆØ±ÙˆØ¯</button>
            <div id="loginResult" class="mt-3 text-danger small text-center"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="dashboard-section" class="d-none">
      <div class="row g-4 mb-4">
        <div class="col-md-3">
          <div class="metric-card">
            <div class="label">Ø­Ø¬Ù… Ú©Ù„ÛŒ Ù¾Ù†Ù„</div>
            <div id="total-traffic" class="value">0 GB</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="label">Ø­Ø¬Ù… Ù…ØµØ±ÙÛŒ</div>
            <div id="used-traffic" class="value">0 GB</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="label">Ø­Ø¬Ù… Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡</div>
            <div id="remaining-traffic" class="value">0 GB</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="label">Ù¾ÛŒØ´\u200cØ¨ÛŒÙ†ÛŒ Ø§ØªÙ…Ø§Ù… Ø­Ø¬Ù…</div>
            <div id="estimated-expiry" class="value">Ù†Ø§Ù…Ø´Ø®Øµ</div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-md-6">
          <div class="card p-3">
            <h5 class="card-title">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±</h5>
            <input type="text" id="searchUser" class="form-control mb-2" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±">
            <button class="btn btn-secondary w-100" onclick="fetchUser()">Ø¬Ø³ØªØ¬Ùˆ</button>
            <div id="userInfo" class="mt-3 small"></div>
            <div id="userSearchError" class="mt-2 text-danger small"></div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card p-3">
            <h5 class="card-title">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù¾Ø± Ù…ØµØ±Ù / Ú©Ù… Ù…ØµØ±Ù</h5>
            <div class="row">
                <div class="col-6">
                    <h6>ğŸ”º Ù¾Ø± Ù…ØµØ±Ù:</h6>
                    <pre id="top-users-list" class="small text-muted"></pre>
                </div>
                <div class="col-6">
                    <h6>ğŸ”» Ú©Ù… Ù…ØµØ±Ù:</h6>
                    <pre id="least-users-list" class="small text-muted"></pre>
                </div>
            </div>
            <div id="summaryError" class="mt-2 text-danger small"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Worker URL (replace with your actual worker URL)
    const WORKER_URL = 'https://home-vor.amiruserbot7.workers.dev/';

    let adminToken = localStorage.getItem('adminToken') || ""; // Load token from local storage

    // DOM Elements
    const loginSection = document.getElementById('login-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const adminUser = document.getElementById('adminUser');
    const adminPass = document.getElementById('adminPass');
    const loginResult = document.getElementById('loginResult');
    const searchUser = document.getElementById('searchUser');
    const userInfo = document.getElementById('userInfo');
    const userSearchError = document.getElementById('userSearchError');
    const topUsersList = document.getElementById('top-users-list');
    const leastUsersList = document.getElementById('least-users-list');
    const summaryError = document.getElementById('summaryError');

    const totalTrafficElem = document.getElementById('total-traffic');
    const usedTrafficElem = document.getElementById('used-traffic');
    const remainingTrafficElem = document.getElementById('remaining-traffic');
    const estimatedExpiryElem = document.getElementById('estimated-expiry');
    // Note: Panel creation date and elapsed days are not directly available from Marzban API
    // They will be displayed as '--' as per current API analysis

    // Helper to format bytes
    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function bytesToGb(bytes) {
        return bytes / (1024 * 1024 * 1024);
    }

    async function login() {
      const username = adminUser.value.trim();
      const password = adminPass.value.trim();
      loginResult.textContent = "Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...";
      loginResult.classList.remove('text-success', 'text-danger');
      loginResult.classList.add('text-info');

      if (!username || !password) {
        loginResult.textContent = "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù„Ø§Ø²Ù… Ø§Ø³Øª.";
        loginResult.classList.remove('text-info');
        loginResult.classList.add('text-danger');
        return;
      }

      try {
        const res = await fetch(`${WORKER_URL}login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        const data = await res.json();
        if (res.ok) {
          adminToken = data.access_token;
          localStorage.setItem('adminToken', adminToken); // Save token
          loginResult.textContent = "ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚!";
          loginResult.classList.remove('text-info', 'text-danger');
          loginResult.classList.add('text-success');
          loadDashboardData(); // Load all dashboard data
          loginSection.classList.add('d-none'); // Hide login section
          dashboardSection.classList.remove('d-none'); // Show dashboard
        } else {
          loginResult.textContent = data.message || data.error || "Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯";
          loginResult.classList.remove('text-info', 'text-success');
          loginResult.classList.add('text-danger');
        }
      } catch (error) {
        console.error("Login error:", error);
        loginResult.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.";
        loginResult.classList.remove('text-info', 'text-success');
        loginResult.classList.add('text-danger');
      }
    }

    async function loadDashboardData() {
        if (!adminToken) {
            loginResult.textContent = "ØªÙˆÚ©Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.";
            loginResult.classList.remove('text-info', 'text-success');
            loginResult.classList.add('text-danger');
            loginSection.classList.remove('d-none');
            dashboardSection.classList.add('d-none');
            return;
        }

        summaryError.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±...";
        summaryError.classList.remove('text-danger');
        summaryError.classList.add('text-info');

        try {
            const res = await fetch(`${WORKER_URL}dashboard-init`, {
                headers: { Authorization: "Bearer " + adminToken },
            });
            const data = await res.json();

            if (res.ok) {
                // Update Metric Cards
                totalTrafficElem.textContent = formatBytes(data.total_traffic_bytes || 0);
                usedTrafficElem.textContent = formatBytes(data.used_traffic_bytes || 0);
                remainingTrafficElem.textContent = formatBytes(data.remaining_traffic_bytes || 0);

                // Estimated expiry (simplified)
                if (data.used_traffic_bytes > 0 && data.remaining_traffic_bytes > 0 && data.elapsed_days > 0) {
                    const dailyUsageBytes = data.used_traffic_bytes / data.elapsed_days;
                    if (dailyUsageBytes > 0) {
                        const remainingDays = data.remaining_traffic_bytes / dailyUsageBytes;
                        estimatedExpiryElem.textContent = `${Math.round(remainingDays)} Ø±ÙˆØ² Ø¯ÛŒÚ¯Ø±`;
                    } else {
                        estimatedExpiryElem.textContent = 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯';
                    }
                } else {
                    estimatedExpiryElem.textContent = 'Ù†Ø§Ù…Ø´Ø®Øµ';
                }

                // Update Top/Least Users
                const top = (data.top_users || []).map(u => `${u.username} (${formatBytes(u.used_traffic_bytes)})`).join("\n");
                const least = (data.least_users || []).map(u => `${u.username} (${formatBytes(u.used_traffic_bytes)})`).join("\n");
                
                topUsersList.textContent = top || 'Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
                leastUsersList.textContent = least || 'Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';

                summaryError.textContent = ""; // Clear error message
                summaryError.classList.remove('text-info', 'text-danger');

            } else {
                summaryError.textContent = data.message || data.error || "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯";
                summaryError.classList.remove('text-info');
                summaryError.classList.add('text-danger');
                if (res.status === 401 || res.status === 403) {
                    adminToken = ""; // Clear invalid token
                    localStorage.removeItem('adminToken');
                    loginResult.textContent = data.message || "Ù†Ø´Ø³Øª Ø´Ù…Ø§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.";
                    loginResult.classList.remove('text-info', 'text-success');
                    loginResult.classList.add('text-danger');
                    loginSection.classList.remove('d-none');
                    dashboardSection.classList.add('d-none');
                }
            }
        } catch (error) {
            console.error("Load dashboard data error:", error);
            summaryError.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯.";
            summaryError.classList.remove('text-info');
            summaryError.classList.add('text-danger');
        }
    }

    async function fetchUser() {
      const username = searchUser.value.trim();
      userInfo.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...";
      userInfo.classList.remove('text-danger');
      userInfo.classList.add('text-info');
      userSearchError.textContent = "";

      if (!username) {
        userSearchError.textContent = "Ù„Ø·ÙØ§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.";
        userSearchError.classList.remove('d-none');
        userInfo.textContent = "";
        return;
      }
      userSearchError.classList.add('d-none');

      try {
        // Note: The /?name=... endpoint does not require Authorization header
        const res = await fetch(`${WORKER_URL}?name=${username}&step=info`); 
        const data = await res.json();

        if (res.ok && data.username) { // Assuming data.username exists for success
          userInfo.innerHTML = `
            <b>Ú©Ø§Ø±Ø¨Ø±:</b> ${data.username}<br>
            <b>Ù…ØµØ±Ù:</b> ${formatBytes(data.used_traffic_bytes || 0)}<br>
            <b>Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡:</b> ${formatBytes(data.remaining_traffic_bytes || 0)}<br>
            <b>ÙˆØ¶Ø¹ÛŒØª:</b> ${data.status || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          `;
          userInfo.classList.remove('text-info', 'text-danger');
          userInfo.classList.add('text-success');
        } else {
          userInfo.textContent = data.message || data.error || "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.";
          userInfo.classList.remove('text-info', 'text-success');
          userInfo.classList.add('text-danger');
        }
      } catch (error) {
        console.error("Fetch user error:", error);
        userInfo.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±.";
        userInfo.classList.remove('text-info', 'text-success');
        userInfo.classList.add('text-danger');
      }
    }

    // Initial check on page load
    document.addEventListener('DOMContentLoaded', () => {
      if (adminToken) {
        loginSection.classList.add('d-none'); // Hide login section
        dashboardSection.classList.remove('d-none'); // Show dashboard
        loadDashboardData(); // Load data if already logged in
      }
    });

  </script>
</body>
</html>
